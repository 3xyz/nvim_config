local cmd = vim.cmd             -- execute Vim commands
local exec = vim.api.nvim_exec  -- execute Vimscript
local g = vim.g                 -- global variables
local opt = vim.opt             -- global/buffer/windows-scoped options

g.mapleader = ','
-- ÐÐ°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð° Ñ Ñ€ÑƒÑÑÐºÐ¾Ð³Ð¾ Ð½Ð° Ð°Ð½Ð³Ð»Ð¸Ð¹ÑÐºÐ¸Ð¹
g.translate_source = 'ru'
g.translate_target = 'en'
-- ÐžÑ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð´ÐµÑ„Ð¾Ð»Ñ‚Ð½Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð¾Ð²Ð¾Ð³Ð¾ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð°
g.loaded_netrw = 1
g.loaded_netrwPlugin = 1
-- ÐšÐ¾Ð¼Ð¿Ð°ÐºÑ‚Ð½Ñ‹Ð¹ Ð²Ð¸Ð´ Ñƒ Ñ‚Ð°Ð³Ð±Ð°Ñ€Ð° Ð¸ ÐžÑ‚Ðº. ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ° Ð¿Ð¾ Ð¸Ð¼ÐµÐ½Ð¸ Ñƒ Ñ‚Ð°Ð³Ð±Ð°Ñ€Ð°
g.tagbar_compact = 1
g.tagbar_sort = 0

-- ÐšÐ¾Ð½Ñ„Ð¸Ð³ ale + eslint
g.ale_fixers = { javascript= { 'eslint' } }
g.ale_sign_error = 'ðŸ¥µ'
g.ale_sign_warning = 'ðŸ¥¶'
g.ale_fix_on_save = 1
-- Ð—Ð°Ð¿ÑƒÑÐº Ð»Ð¸Ð½Ñ‚ÐµÑ€Ð°, Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ð¸
g.ale_lint_on_text_changed = 'never'
g.ale_lint_on_insert_leave = 0

-----------------------------------------------------------
-- Ð“Ð»Ð°Ð²Ð½Ñ‹Ðµ
-----------------------------------------------------------
opt.colorcolumn = '80'              -- Ð Ð°Ð·Ð´ÐµÐ»Ð¸Ñ‚ÐµÐ»ÑŒ Ð½Ð° 80 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²
opt.cursorline = true               -- ÐŸÐ¾Ð´ÑÐ²ÐµÑ‚ÐºÐ° ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ñ ÐºÑƒÑ€ÑÐ¾Ñ€Ð¾Ð¼
opt.spelllang= { 'en_us', 'ru' }    -- Ð¡Ð»Ð¾Ð²Ð°Ñ€Ð¸ Ñ€ÑƒÑ eng
opt.number = true                   -- Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð½ÑƒÐ¼ÐµÑ€Ð°Ñ†Ð¸ÑŽ ÑÑ‚Ñ€Ð¾Ðº
opt.relativenumber = true           -- Ð’ÐºÐ». Ð¾Ñ‚Ð½Ð¾ÑÐ¸Ñ‚ÐµÐ»ÑŒÐ½ÑƒÑŽ Ð½ÑƒÐ¼ÐµÑ€Ð°Ñ†Ð¸ÑŽ ÑÑ‚Ñ€Ð¾Ðº
opt.so=8                            -- ÐšÑƒÑ€ÑÐ¾Ñ€ Ð²ÑÐµÐ³Ð´Ð° Ð² Ñ†ÐµÐ½Ñ‚Ñ€Ðµ ÑÐºÑ€Ð°Ð½Ð°
opt.undofile = true                 -- Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð¾Ñ‚ÐºÐ°Ñ‚Ð° Ð½Ð°Ð·Ð°Ð´
opt.splitright = true               -- vertical split Ð²Ð¿Ñ€Ð°Ð²Ð¾
opt.splitbelow = true               -- horizontal split Ð²Ð½Ð¸Ð·

-----------------------------------------------------------
-- Ð¦Ð²ÐµÑ‚Ð¾Ð²Ð°Ñ ÑÑ…ÐµÐ¼Ð°
-----------------------------------------------------------
opt.termguicolors = true      --  24-bit RGB colors
--cmd 'colorscheme onedark'
cmd 'colorscheme ayu'
require('lualine').setup()
local function update_hl(group, tbl)
	local old_hl = vim.api.nvim_get_hl_by_name(group, true)
	local new_hl = vim.tbl_extend('force', old_hl, tbl)
	vim.api.nvim_set_hl(0, group, new_hl)
end
update_hl('Comment', { italic = true })

-----------------------------------------------------------
-- Ð¢Ð°Ð±Ñ‹ Ð¸ Ð¾Ñ‚ÑÑ‚ÑƒÐ¿Ñ‹
-----------------------------------------------------------
cmd([[
filetype indent plugin on
syntax enable
]])
opt.expandtab = true      -- use spaces instead of tabs
opt.shiftwidth = 4        -- shift 4 spaces when tab
opt.tabstop = 4           -- 1 tab == 4 spaces
opt.smartindent = true    -- autoindent new lines
-- don't auto commenting new lines
cmd [[au BufEnter * set fo-=c fo-=r fo-=o]]
-- remove line lenght marker for selected filetypes
cmd [[autocmd FileType text,markdown,html,xhtml,javascript setlocal cc=0]]
-- 2 spaces for selected filetypes
cmd [[
autocmd FileType bash,c,xml,html,xhtml,css,scss,javascript,lua,yaml,htmljinja setlocal shiftwidth=2 tabstop=2
]]
-- Ð¡ ÑÑ‚Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¾Ð¹ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð½Ð¾ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ html Ñ„Ð°Ð¹Ð», ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ jinja2
cmd[[ autocmd BufNewFile,BufRead *.html set filetype=htmldjango ]]

-----------------------------------------------------------
-- ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ Ñ„Ð¸ÑˆÐºÐ¸
-----------------------------------------------------------
-- Ð—Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°ÐµÑ‚ Ð³Ð´Ðµ nvim Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ñ€Ð°Ð· Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð» Ñ„Ð°Ð¹Ð»
cmd [[
autocmd BufReadPost * if line("'\"") > 1 && line("'\"") <= line("$") | exe "normal! g'\"" | endif
]]
-- ÐŸÐ¾Ð´ÑÐ²ÐµÑ‡Ð¸Ð²Ð°ÐµÑ‚ Ð½Ð° Ð´Ð¾Ð»Ð¸ ÑÐµÐºÑƒÐ½Ð´Ñ‹ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½ÑƒÑŽ Ñ‡Ð°ÑÑ‚ÑŒ Ñ‚ÐµÐºÑÑ‚Ð°
--exec([[
--augroup YankHighlight
--autocmd!
--autocmd TextYankPost * silent! lua vim.highlight.on_yank{higroup="IncSearch", timeout=700}
--augroup end
--]], false)

-----------------------------------------------------------
-- Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð´Ð»Ñ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð²
-----------------------------------------------------------
-- LSP settings
local lsp_installer = require("nvim-lsp-installer")
lsp_installer.on_server_ready(function(server)
    local opts = {}
    if server.name == "sumneko_lua" then
        -- only apply these settings for the "sumneko_lua" server
        opts.settings = {
            Lua = {
                diagnostics = {
                    -- Get the language server to recognize the 'vim', 'use' global
                    globals = {'vim', 'use'},
                },
                workspace = {
                    -- Make the server aware of Neovim runtime files
                    library = vim.api.nvim_get_runtime_file("", true),
                },
                -- Do not send telemetry data containing a randomized but unique identifier
                telemetry = {
                    enable = false,
                },
            },
        }
    end
    server:setup(opts)
end)

-- nvim-cmp supports additional completion capabilities
local capabilities = vim.lsp.protocol.make_client_capabilities()
capabilities = require('cmp_nvim_lsp').default_capabilities(capabilities)
vim.o.completeopt = 'menuone,noselect'
-- luasnip setup
local luasnip = require 'luasnip'
-- nvim-cmp setup
local has_words_before = function()
  local cursor = vim.api.nvim_win_get_cursor(0)
  return (vim.api.nvim_buf_get_lines(0, cursor[1] - 1, cursor[1], true)[1] or ''):sub(cursor[2], cursor[2]):match('%s') 
end
local cmp = require 'cmp'
cmp.setup {
    snippet = {
        expand = function(args)
            luasnip.lsp_expand(args.body)
        end,
    },
    mapping = {
      ["<Tab>"] = cmp.mapping(function(fallback)
        if cmp.visible() then
          cmp.select_next_item()
        elseif luasnip.expand_or_jumpable() then
          luasnip.expand_or_jump()
        else
          fallback()
        end
      end, { "i", "s" }),
      ["<S-Tab>"] = cmp.mapping(function(fallback)
        if cmp.visible() then
          cmp.select_prev_item()
        elseif luasnip.jumpable(-1) then
          luasnip.jump(-1)
        else
          fallback()
        end
      end, { "i", "s" }),
      ['<C-b>'] = cmp.mapping(cmp.mapping.scroll_docs(-4), { 'i', 'c' }),
      ['<C-f>'] = cmp.mapping(cmp.mapping.scroll_docs(4), { 'i', 'c' }),
      ['<C-Space>'] = cmp.mapping(cmp.mapping.complete(), { 'i', 'c' }),
      ['<C-y>'] = cmp.config.disable,
      ['<C-e>'] = cmp.mapping({
        i = cmp.mapping.abort(),
        c = cmp.mapping.close(),
      }),
      ['<CR>'] = cmp.mapping.confirm({ select = true }),
    },
    sources = {
        { name = 'nvim_lsp' },
        { name = 'luasnip' },
        { name = 'path' },
        { name = 'buffer', option = {
            get_bufnrs = function()
                return vim.api.nvim_list_bufs()
            end
        },
    },
},
}

-- neo-tree
-----------------------------------------------------------
-- ÐŸÑ€Ð¾Ñ‡Ð¸Ðµ Ð¿Ð»Ð°Ð³Ð¸Ð½Ñ‹
-----------------------------------------------------------
require("nvim-tree").setup()
require("bufferline").setup()
require('Comment').setup()
